<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meu Perfil</title>

<link rel="stylesheet" href="/css/navbar.css" />

<style>
  :root {
    --bg1: #1a1a1a;
    --bg2: #2e2e2e;
    --card: #737372;
    --input-bg: #e8e8e8;
    --accent: #000;
    --white: #fff;
    --transition-time: 0.48s;
  }

  * { box-sizing: border-box; }

  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: var(--bg);
    color: var(--white);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
  }

  #navbar-placeholder { position: relative; z-index: 5; }

  .container-form {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 100px;
    min-height: calc(100vh - 100px);
  }

  form {
    background: var(--card);
    backdrop-filter: blur(10px);
    width: 100%;
    max-width: 940px;
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.6);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease-in-out;
  }

  h2, h3 {
    text-align: center;
    color: #000;
    margin: 10px 0 24px;
  }

  label {
    display: block;
    font-weight: 600;
    color: #111;
    margin-bottom: 6px;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    background: var(--input-bg);
    font-size: 14px;
    color: #000;
    transition: box-shadow 0.3s ease, transform 0.2s ease;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    box-shadow: 0 0 6px #000;
    transform: translateY(-2px);
  }

  textarea { resize: vertical; min-height: 70px; }

  .form-group { flex: 1; min-width: 180px; }
  .form-row { display: flex; gap: 14px; margin-bottom: 18px; flex-wrap: wrap; }
  .actions { display: flex; gap: 12px; margin-top: 18px; }

  button {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.25s ease;
    letter-spacing: 0.3px;
  }

  .btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: all 0.25s ease; letter-spacing: 0.3px; }
  .btn-primary { background: linear-gradient(135deg, #000, #3a3a3a); color: #fff; }
  .btn-primary:hover { background: linear-gradient(135deg, #111, #555); transform: translateY(-2px); }
  .btn-secondary { background: #444; color: #fff; }
  .btn-secondary:hover { background: #000; transform: translateY(-2px); }
  .btnExcluir { background-color: #c0392b; }
  .btnExcluir:hover { background-color: rgb(231, 90, 90); }
  .btnCancelar { background-color: #444; }
  .btnCancelar:hover { background-color: #000; transform: translateY(-2px); }

  @media (max-width: 880px) {
    .form-row { flex-direction: column; }
    form { padding: 22px; }
  }
</style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container-form">
  <form id="formPerfil">
    <h2>Meu Perfil</h2>

    <div class="form-row">
      <div class="form-group">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required />
      </div>
      <div class="form-group">
        <label for="sobrenome">Sobrenome</label>
        <input type="text" id="sobrenome" name="sobrenome" required />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" disabled />
      </div>
      <div class="form-group">
        <label for="datanasc">Data de Nascimento</label>
        <input type="date" id="datanasc" name="datanasc" required />
      </div>
      <div class="form-group">
        <label for="telefone">Telefone</label>
        <input type="tel" id="telefone" name="telefone" required />
      </div>
      <div class="form-group">
        <label for="genero">Gênero</label>
        <select id="genero" name="genero" required>
          <option value="">Selecione...</option>
          <option value="feminino">Feminino</option>
          <option value="masculino">Masculino</option>
          <option value="nao_binario">Não-binário</option>
          <option value="outro">Outro</option>
          <option value="prefiro_nao_dizer">Prefiro não dizer</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="email">E-mail</label>
        <input type="email" id="email" name="email" required />
      </div>
    </div>

    <hr />

    <div class="form-row">
      <div class="form-group">
        <label for="rua">Rua</label>
        <input type="text" id="rua" name="rua" required />
      </div>
      <div class="form-group">
        <label for="numero">Número</label>
        <input type="text" id="numero" name="numero" required />
      </div>
      <div class="form-group">
        <label for="complemento">Complemento</label>
        <input type="text" id="complemento" name="complemento" />
      </div>
      <div class="form-group">
        <label for="bairro">Bairro</label>
        <input type="text" id="bairro" name="bairro" required />
      </div>
      <div class="form-group">
        <label for="cidade">Cidade</label>
        <input type="text" id="cidade" name="cidade" required />
      </div>
      <div class="form-group">
        <label for="estado">Estado</label>
        <select id="estado" name="estado" required>
          <option value="">Selecione...</option>
          <option>AC</option><option>AL</option><option>AM</option><option>BA</option><option>CE</option><option>DF</option>
          <option>ES</option><option>GO</option><option>MA</option><option>MG</option><option>PA</option><option>PB</option>
          <option>PE</option><option>PR</option><option>RJ</option><option>RN</option><option>RS</option><option>SC</option>
          <option>SP</option><option>SE</option><option>TO</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cep">CEP</label>
        <input type="text" id="cep" name="cep" required />
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn btn-primary">Salvar Alterações</button>
      <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
      <button type="button" id="btnExcluir" class="btnExcluir btn">Excluir Conta</button>
    </div>

  </form>
</div>

<div id="footer-placeholder"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById('formPerfil');

  // Carregar dados do usuário
  fetch('/api/usuarios/me')
    .then(res => res.json())
    .then(dados => {
      for (const key in dados) {
        if (!form[key]) continue;
        if (key === 'datanasc' && dados[key]) {
          const d = new Date(dados[key]);
          form[key].value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        } else {
          form[key].value = dados[key];
        }
      }
    })
    .catch(err => console.error('Erro ao carregar dados:', err));

  // Submissão do formulário
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const dadosAtualizados = {};
    new FormData(form).forEach((v,k) => { if (v) dadosAtualizados[k] = v; });

    try {
      const res = await fetch('/api/usuarios/me', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dadosAtualizados)
      });
      if (!res.ok) throw new Error('Erro ao atualizar perfil.');
      alert('Perfil atualizado com sucesso!');
    } catch(err) {
      alert(err.message);
      console.error(err);
    }
  });

  // Cancelar
  document.getElementById('btnCancelar').addEventListener('click', () => {
    if (confirm('Cancelar alterações e voltar para a página inicial?')) window.location.href = '/';
  });

  // Carregar navbar e footer
  fetch('/components/navbarClient.html').then(r => r.text()).then(t => document.getElementById('navbar-placeholder').innerHTML = t);
  fetch('/components/footer.html').then(r => r.text()).then(t => document.getElementById('footer-placeholder').innerHTML = t);

  // --- Excluir conta com verificação do tipo ---
  fetch('/api/usuarios/tipo')
    .then(res => res.json())
    .then(data => {
      const btnExcluir = document.getElementById('btnExcluir');
      if (data.tipo === 'profissional') {
        btnExcluir.addEventListener('click', () => {
          const userId = prompt('Informe o ID do usuário que deseja excluir:');
          if (!userId) return;
          if (confirm('Tem certeza que deseja excluir este usuário?')) {
            fetch(`/api/usuarios/${userId}`, { method: 'DELETE' })
              .then(res => {
                if (res.ok) alert('Usuário excluído com sucesso!');
                else return res.json().then(d => { throw new Error(d.mensagem || 'Erro ao excluir usuário.'); });
              })
              .catch(err => alert(err.message));
          }
        });
      } else {
        btnExcluir.addEventListener('click', () => {
          if (confirm('Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.')) {
            fetch('/api/usuarios/me', { method: 'DELETE' })
              .then(res => {
                if (res.ok) {
                  alert('Conta excluída com sucesso!');
                  window.location.href = '/login';
                } else {
                  return res.json().then(d => { throw new Error(d.mensagem || 'Erro ao excluir conta.'); });
                }
              })
              .catch(err => alert(err.message));
          }
        });
      }
    })
    .catch(err => console.error('Erro ao verificar tipo de usuário:', err));

});
</script>
</body>
</html>
